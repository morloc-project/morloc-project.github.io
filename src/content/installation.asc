=== Installing and managing morloc versions

The easiest way to run Morloc is through containers in a UNIX environment. Linux
will work natively. MacOS and Windows are more complicated and I'll deal with
their special later on. For Windows, you will need to install through the
https://learn.microsoft.com/en-us/windows/wsl/about[Windows Subsystem for Linux].

The only dependency is a container engine, currently two --
https://docs.docker.com/engine/install/[docker] and
https://podman.io/docs/installation[podman] -- are supported.

.Podman instructions
[%collapsible]
====

Unlike Docker, `podman` runs rootless by default, so no sudo is required. On
Linux, it also runs natively with no daemons.

On MacOS and Windows (even through WSL), a virtual machine is required. So you
will need to initialize `podman` as so:

[%nowrap, console]
----
$ podman init
$ podman start
----

You can confirm that podman is running by entering

[%nowrap, console]
----
$ podman --version
podman version 5.4.1   # version on my current setup
----

++++
<hr>
++++

====

.Docker instructions
[%collapsible]
====

Docker requires either sudo access or
https://docs.docker.com/engine/security/rootless/[rootless mode] configuration.

Verify Docker is running:

[%nowrap, console]
----
$ docker --version
$ docker run hello-world
----

++++
<hr>
++++

====


After confirming either Podman or Docker is running on your system, pull an
installation script from
https://github.com/morloc-project/morloc-manager[morloc-project/morloc-manager]:

[%nowrap, console]
----
$ curl -o morloc-manager https://raw.githubusercontent.com/morloc-project/morloc-manager/refs/heads/main/morloc-manager.sh
----

`morloc-manager` is a (mostly) POSIX compatible shell script that is tested on Linux and
MacOS. On Windows, you should may run this in the Windows Subsystem for Linux
(WSL). You may execute `morloc-manager` directly, for example `bash morloc-manager`. But it is more
convenient to make the script executable and move it to a folder in your
execution path.

The script provides usage information on request:

[%nowrap, console]
----
$ morloc-manager -h
$ morloc-manager install -h
$ morloc-manager uninstall -h
----

The `install` subcommand will build the Morloc home directory, install required
containers, and generate four executable scripts.

*The first script is `menv`*. It runs arbitrary commands in a Morloc container. It
can be used to compile and run Morloc programs. For example:

[%nowrap, console]
----
$ menv morloc make -o foo foo.loc
$ menv ./foo double 21
----

The `menv` script mounts the working directory and the `~/.local/share/morloc/<version>`
directory. It builds the program using the containers version of the Morloc
compiler and Morloc libraries that are defined in the version-specific home
directory. It cannot see any dependencies on your local system.

*The second script is `morloc-shell`*. This script is the same as the above script
except that you enter the container in an interactive shell rather than just
running one command. The container has installations for Python, R, and C++
compiler. It also contains vim and other conveniences

*The third script is `menv-dev`*. This runs commands in a dev container where all
Haskell tools required for building Morloc from source are installed. To build
Morloc from source, do the following:

[%nowrap, console]
----
$ git clone git@github.com:morloc-project/morloc
$ cd morloc
$ menv-dev stack install --fast
$ menv-dev stack test --fast
----

This will build the version that was cloned from GitHub. Now you can use
`menv-dev` as you would `menv`.

*The fourth script is `morloc-shell-dev`*. This script lets you enter the dev
shell.

The Morloc compiler always considers `~/.local/share/morloc` to be the
Morloc home directory. The containers mount separate folders from the local
`~/.local/share/morloc/versions` folder to this expected home directory in the
container. This means the different versions of Morloc installed, as well as the
special `local` version used by the dev container, do not have overlapping
libraries and modules.

Throughout the rest of this manual, whenever I show an example that uses
Morloc, you can assume that I am running it from within a container after
calling `morloc-shell` or `morloc-shell-dev`.

=== Handling dependencies

`morloc-manager` will install the Morloc compiler and default
language run-times. This is sufficient to play with Morloc and run most of the
demos. However, if you write any code that has additional dependencies, you will
need to augment the environment. As of v0.5.0, `morloc-manager` provides
support for specifying containers that build on the default containers.

Let's say we want to create a new environment for scientific computing with Python:

[%nowrap, console]
----
$ morloc-manager env --init scipy
----

This will create a stub Dockerfile at
`~/.local/share/morloc/deps/scipy.Dockerfile`. It can be modified to specify
whatever additional dependencies are needed. Then the environment can be built
and selected as follows:

[%nowrap, console]
----
$ morloc-manager env scipy
----

All existing environments can be listed as well:

[%nowrap, console]
----
$ morloc-manager env --list
----

This feature is new and still experimental. Any feedback would be appreciated.
